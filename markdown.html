<script>
  const markdownInput = document.getElementById('markdown-input');
  const preview = document.getElementById('preview');
  const listenBtn = document.getElementById('listen-btn');
  const downloadBtn = document.getElementById('download-btn');
  const pomodoroBtn = document.getElementById('pomodoro-btn');
  const qrcodeBtn = document.getElementById('qrcode-btn');
  const status = document.getElementById('status');
  const downloadModal = document.getElementById('download-modal');
  const qrcodeModal = document.getElementById('qrcode-modal');
  const downloadModalClose = document.getElementById('download-modal-close');
  const qrcodeModalClose = document.getElementById('qrcode-modal-close');
  const pomodoroPanel = document.getElementById('pomodoro-panel');
  const pomodoroStart = document.getElementById('pomodoro-start');
  const pomodoroPause = document.getElementById('pomodoro-pause');
  const pomodoroReset = document.getElementById('pomodoro-reset');
  const pomodoroTime = document.getElementById('pomodoro-time');
  const readabilityScore = document.getElementById('readability-score');
  const downloadQrcodeBtn = document.getElementById('download-qrcode-btn');

  // Initialize Marked.js
  marked.setOptions({
    breaks: true,
    highlight: (code, lang) => {
      const language = hljs.getLanguage(lang) ? lang : 'plaintext';
      return hljs.highlight(code, { language }).value;
    }
  });

  // Highlight existing code
  function highlightPreview() {
    preview.querySelectorAll('pre code').forEach((el) => {
        hljs.highlightElement(el);
    });
  }

  // Modal handling
  function openModal(modal) {
    modal.classList.add('active');
    status.textContent = `${modal.id.replace('-modal', '').charAt(0).toUpperCase() + modal.id.slice(1).replace('-modal', '')} options opened.`;
  }
  function closeModal(modal) {
    modal.classList.remove('active');
    status.textContent = 'Write Markdown and preview it.';
  }

  downloadBtn.addEventListener('click', (e) => { e.preventDefault(); openModal(downloadModal); });
  qrcodeBtn.addEventListener('click', (e) => {
    e.preventDefault();
    const text = markdownInput.value.trim();
    if (!text) {
      status.textContent = 'Enter Markdown to generate QR code.';
      return;
    }
    document.getElementById('qrcode').innerHTML = ''; // Clear previous QR code
    new QRCode(document.getElementById('qrcode'), { text: text, width: 200, height: 200, colorDark: '#000000', colorLight: '#ffffff', correctLevel: QRCode.CorrectLevel.H });
    openModal(qrcodeModal);
  });
  downloadModalClose.addEventListener('click', () => closeModal(downloadModal));
  qrcodeModalClose.addEventListener('click', () => closeModal(qrcodeModal));

  // Download QR Code
  downloadQrcodeBtn.addEventListener('click', (e) => {
    e.preventDefault();
    const canvas = document.getElementById('qrcode').querySelector('canvas');
    if (!canvas) { status.textContent = 'No QR code to download.'; closeModal(qrcodeModal); return; }
    const url = canvas.toDataURL('image/png');
    const a = document.createElement('a');
    a.href = url; a.download = 'qrcode.png'; document.body.appendChild(a); a.click(); document.body.removeChild(a);
    status.textContent = 'QR code downloaded.'; closeModal(qrcodeModal);
  });

  // Live preview and readability
  markdownInput.addEventListener('input', () => {
    preview.innerHTML = marked.parse(markdownInput.value);
    highlightPreview();
    updateReadabilityScore();
  });

  // Listen to text
  listenBtn.addEventListener('click', (e) => {
    e.preventDefault();
    const text = markdownInput.value.trim();
    if (!text) { status.textContent = 'Enter Markdown to listen.'; return; }
    const plainText = markdownInput.value.replace(/[#*_>~`]/g, '').trim();
    const utterance = new SpeechSynthesisUtterance(plainText);
    status.textContent = 'Playing audio...';
    speechSynthesis.cancel();
    speechSynthesis.speak(utterance);
    utterance.onend = () => { status.textContent = 'Audio done.'; };
  });

  function downloadFile(blob, filename) {
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = filename; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
  }

  document.getElementById('download-md-btn').addEventListener('click', (e) => {
    e.preventDefault();
    const text = markdownInput.value.trim();
    if (!text) { status.textContent = 'Enter Markdown to download.'; closeModal(downloadModal); return; }
    downloadFile(new Blob([text], { type: 'text/markdown' }), 'document.md');
    status.textContent = 'Markdown downloaded.'; closeModal(downloadModal);
  });

  document.getElementById('download-html-btn').addEventListener('click', (e) => {
    e.preventDefault();
    const text = markdownInput.value.trim();
    if (!text) { status.textContent = 'Enter Markdown to download.'; closeModal(downloadModal); return; }
    const html = marked.parse(text);
    downloadFile(new Blob([`<!DOCTYPE html><html><head><style>body{font-family:sans-serif;}</style></head><body>${html}</body></html>`], { type: 'text/html' }), 'document.html');
    status.textContent = 'HTML downloaded.'; closeModal(downloadModal);
  });

  document.getElementById('download-pdf-btn').addEventListener('click', (e) => {
    e.preventDefault();
    const text = markdownInput.value.trim();
    if (!text) { status.textContent = 'Enter Markdown to download.'; closeModal(downloadModal); return; }
    const html = marked.parse(text);
    const element = document.createElement('div');
    element.innerHTML = `<div style="padding: 20px;">${html}</div>`;
    const opt = { margin: 0.5, filename: 'document.pdf', image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2 }, jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' } };
    html2pdf().set(opt).from(element).save();
    status.textContent = 'PDF downloaded.'; closeModal(downloadModal);
  });

  // Pomodoro
  let pomodoroInterval = null; let isWorkSession = true; let timeLeft = 25 * 60; const workDuration = 25 * 60; const breakDuration = 5 * 60;
  function formatTime(seconds) { const minutes = Math.floor(seconds / 60); const secs = seconds % 60; return `${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`; }
  function updatePomodoroDisplay() { pomodoroTime.textContent = formatTime(timeLeft); }
  pomodoroBtn.addEventListener('click', (e) => { e.preventDefault(); pomodoroPanel.classList.toggle('active'); status.textContent = pomodoroPanel.classList.contains('active') ? 'Pomodoro opened.' : 'Pomodoro closed.'; });
  pomodoroStart.addEventListener('click', (e) => { e.preventDefault(); if (!pomodoroInterval) { pomodoroInterval = setInterval(() => { timeLeft--; if (timeLeft < 0) { isWorkSession = !isWorkSession; timeLeft = isWorkSession ? workDuration : breakDuration; status.textContent = isWorkSession ? 'Work session started!' : 'Break time!'; } updatePomodoroDisplay(); }, 1000); pomodoroStart.disabled = true; pomodoroPause.disabled = false; status.textContent = isWorkSession ? 'Work session started!' : 'Break time!'; } });
  pomodoroPause.addEventListener('click', (e) => { e.preventDefault(); clearInterval(pomodoroInterval); pomodoroInterval = null; pomodoroStart.disabled = false; pomodoroPause.disabled = true; status.textContent = 'Pomodoro paused.'; });
  pomodoroReset.addEventListener('click', (e) => { e.preventDefault(); clearInterval(pomodoroInterval); pomodoroInterval = null; isWorkSession = true; timeLeft = workDuration; updatePomodoroDisplay(); pomodoroStart.disabled = false; pomodoroPause.disabled = true; status.textContent = 'Pomodoro reset.'; });

  // Readability
  function updateReadabilityScore() {
    const text = markdownInput.value.trim();
    if (!text) { readabilityScore.textContent = 'Readability: N/A'; return; }
    const plainText = text.replace(/[#*_>~`]/g, '').trim();
    const sentences = (plainText.match(/[.!?]+/g) || []).length + 1;
    const words = (plainText.match(/\s+/g) || []).length + 1;
    const syllables = plainText.toLowerCase().split(/\s+/).reduce((sum, word) => { return sum + (word.match(/[aeiouy]{1,2}/g) || []).length; }, 0);
    const fkGrade = sentences && words ? Math.round((0.39 * (words / sentences) + 11.8 * (syllables / words) - 15.59)*10)/10 : 0;
    readabilityScore.textContent = `Readability: Grade ${fkGrade}`;
  }

  // --- Sidebar Logic ---
  const hamburger = document.getElementById('hamburger-menu');
  const overlay = document.querySelector('.sidebar-overlay');
  hamburger.addEventListener('click', () => { document.body.classList.toggle('sidebar-open'); });
  overlay.addEventListener('click', () => { document.body.classList.remove('sidebar-open'); });

  // Initial render
  preview.innerHTML = marked.parse(markdownInput.value);
  highlightPreview();
  updateReadabilityScore();
</script>
